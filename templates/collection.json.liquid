{% layout none %}
{% paginate collection.products by 100 %}
[
  {%- for product in collection.products -%}

  {% assign sca_product = product %}
    {% assign sca_product_id_text = "," | append : sca_product.id | append : "," %}
    {% assign sca_price = sca_product.price %}
    {% assign sca_price_min = sca_product.price_min %}
    {% assign sca_price_max = sca_product.price_max %}
    {% assign sca_compare_at_price = sca_product.compare_at_price %}
    {% assign sca_compare_at_price_min = sca_product.compare_at_price_min %}
    {% assign sca_compare_at_price_max = sca_product.compare_at_price_max %}
    {% assign sca_product_available = sca_product.available %}
    {% assign sca_product_variantCount = sca_product.variants.size %}
    {% assign sca_compare_at_price_varies = sca_product.compare_at_price_varies %}
    {% assign sca_price_varies = sca_product.price_varies %}
    {% assign sca_has_only_default_variant = false %}
    {% capture sca_product_variants_json %}{{sca_product.variants | json }}{% endcapture %} 
    {% capture sca_product_json %}
    { {% if sca_all_gift_products_ids == null or sca_all_gift_products_ids contains sca_product_id_text %}
        {% assign sca_product_available = false %}
        {% assign sca_product_variantCount = 0 %}
        {% assign sca_has_only_default_variant = true %}
        {% assign sca_is_first_variant = true %}
        {% capture sca_variants_json %} 
          [{% for variant in sca_product.variants %}
            {% unless variant.metafields.secomapp.freegifts %}
              {% unless variant.title contains '(Freegifts)' %}
                {% unless variant.title contains '% Off' %}
                  {% unless variant.metafields.shappify_qb.qb_hide == "1" %}
                    {% unless variant.metafields.shappify_bundle.is_bundle == "true" %}
                      {% unless variant.metafields.brodev_scn.hide == "true" %}
                        {% unless variant.metafields.wholesaler2.wholesale %}
                          {% unless variant.metafields.Wholesaler.level %}
                            {% unless variant.title contains '(Wholesale' %}
                              {% if sca_is_first_variant%} 
                                {{ variant | json }}
                                {% assign sca_price = variant.price %} 
                                {% assign sca_price_min = variant.price %} 
                                {% assign sca_price_max = variant.price %} 
                                {% assign sca_compare_at_price = variant.compare_at_price %} 
                                {% assign sca_compare_at_price_min = variant.compare_at_price %} 
                                {% assign sca_compare_at_price_max = variant.compare_at_price %} 
                                {% assign sca_product_available = variant.available %} 
                                {% assign sca_product_variantCount = 1 %} 
                                {% assign sca_is_first_variant = false%}
                              {% else %},
                                {{variant | json }} 
                                {% if sca_price_min >= variant.price %} 
                                  {% assign sca_price_min = variant.price %} 
                                  {% assign sca_price = variant.price %}
                                {% endif %} 
                                {% if sca_price_max <= variant.price %} 
                                  {% assign sca_price_max = variant.price %} 
                                {% endif %} 
                                {% if variant.compare_at_price %} 
                                  {% if sca_compare_at_price_min==null or sca_compare_at_price_min >= variant.compare_at_price %} 
                                    {% assign sca_compare_at_price_min = variant.compare_at_price %} 
                                    {% assign sca_compare_at_price = variant.compare_at_price %} 
                                  {% endif %} 
                                  {% if sca_compare_at_price_max==null or sca_compare_at_price_max < variant.compare_at_price %} 
                                    {% assign sca_compare_at_price_max = variant.compare_at_price %} 
                                  {% endif %} 
                                {% endif %} 
                                {% if variant.available == true %} 
                                    {% assign sca_product_available = true %} 
                                {% endif %} 
                                {% assign sca_product_variantCount = sca_product_variantCount | plus: 1 %}
                              {% endif %}
                            {% endunless %}
                          {% endunless %}
                        {% endunless %}
                      {% endunless %}
                    {% endunless %}
                  {% endunless %}
                {% endunless %}
              {% endunless %}
            {% endunless %}
          {%endfor%} ]
        {% endcapture %}
        {% if sca_price_min < sca_price_max %}
          {% assign sca_price_varies = true %}
        {% else %}
          {% assign sca_price_varies = false %}
        {% endif %}
        {% if sca_compare_at_price_min < sca_compare_at_price_max %}
          {% assign sca_compare_at_price_varies = true %}
        {% else %}
          {% assign sca_compare_at_price_varies = false %}
        {% endif %}
        {% if sca_product_variantCount > 1 %}
          {% assign sca_has_only_default_variant = false %}
        {% endif %}
        {% if sca_product_variantCount == sca_product.variants.size %} 
          "variants":{{ sca_product.variants }},
        {% else %}
          {%assign sca_product_variants_json = sca_variants_json %} "variants":{{ sca_variants_json }},
        {% endif %}
      {% else %} 
        "variants":{{ sca_product_variants_json }},
      {% endif %} 
      "id": {{sca_product.id}}, 
      "title": {{sca_product.title | json}}, 
      "handle": {{sca_product.handle | json}}, 
      "description": {{sca_product.description | json}}, 
      "published_at": "{{sca_product.published_at | date: "%Y-%m-%dT%H-%M-%S%:z" }}", 
      "created_at": "{{sca_product.created_at | date: "%Y-%m-%dT%H-%M-%S%:z" }}", 
      "vendor": {{sca_product.vendor | json}}, 
      "type": {{sca_product.type | json}}, 
      "tags": {{sca_product.tags | json}}, 
      "price": {{sca_price}}, 
      "price_min": {{sca_price_min}}, 
      "price_max": {{sca_price_max}}, 
      "available": {{sca_product.available}}, 
      "price_varies": {{sca_price_varies}}, 
      "compare_at_price": {{sca_compare_at_price}}, 
      "compare_at_price_min": {{sca_compare_at_price_min}}, 
      "compare_at_price_max": {{sca_compare_at_price_max}}, 
      "compare_at_price_varies": {{sca_compare_at_price_varies}}, 
      "images": {{sca_product.images | json}}, 
      "featured_image": {{sca_product.featured_image | json }}, 
      "options": {{sca_product.options | json}}, 
      "media": {{sca_product.media | json }}, 
      "content": {{sca_product.content | json }}} 
    {% endcapture sca_product_json %}
  
    {
      "available": {{ product.available | json }},
      "compare_at_price": {{ sca_compare_at_price | json }},
      "compare_at_price_max": {{ sca_compare_at_price_max | json }},
      "compare_at_price_min": {{ sca_compare_at_price_min | json }},
      "compare_at_price_varies": {{ sca_compare_at_price_varies | json }},
      "created_at": "{{ product.created_at }}",
      "featured_image": "{{ product.featured_image | img_url: 'master' }}",
      "handle": "{{ product.handle }}",
      "id": {{ product.id | json }},
      "images": {{ product.images | json }},
      "media": {{ product.media | json }},
      "options": {{ product.options_with_values | json }},
      "price": {{ sca_price | json }},
      "price_max": {{ sca_price_max | json }},
      "price_min": {{ sca_price_min | json }},
      "price_varies": {{ sca_price_varies | json }},
      "published_at": "{{ product.published_at }}",
      "title": {{ product.title | json }},
      "type": "{{ product.type }}",
      "url": "{{ product.url }}",
      {%- if product.first_available_variant -%}
        "selectedVariant": {
                "title": "{{ product.first_available_variant.title }}",
                "id": {{ product.first_available_variant.id }},
                "available": {{ product.first_available_variant.available }},
                "price": {{ product.first_available_variant.price }}{% if product.first_available_variant.compare_at_price %},
                "compare_at_price": {{ product.first_available_variant.compare_at_price }}
                {% endif %}
        },
        {%- else -%}
        "selectedVariant": {
          "title": "{{ product.first_available_variant.title }}",
          "id": 0,
          "available": false,
          {% for variant in product.variants %}
            "price": {{ variant.price }} {% break %}
          {% endfor %}
        },
    {%- endif -%}
      "variant_inventory":{
        {% for variant in product.variants %}
          {% unless variant.metafields.secomapp.freegifts %}
          {% unless variant.title contains '% off)' %}
            {% unless forloop.first %},{% endunless %}
            "{{variant.id}}":"{{variant.inventory_quantity}}"
          {% endunless %}
          {% endunless %}
        {% endfor %}
        },
      "variants": [
        {%- for variant in product.variants -%}
        {% unless variant.metafields.secomapp.freegifts %}
        {% unless variant.title contains '% off)' %}
          {% unless forloop.first %},{% endunless%}
          {
            "available": {{ variant.available | json }},
            "barcode": {{ variant.barcode | json }},
            "compare_at_price": {{ variant.compare_at_price | json }},
            "featured_image": {{ variant.featured_image | json }},
            "featured_media": {{ variant.featured_media | json }},
            "inventory_management": {{ variant.inventory_management | json }},
            "option1": {{ variant.option1 | json }},
            "option2": {{ variant.option2 | json }},
            "option3": {{ variant.option3 | json }},
            "options": {{ variant.options | json }},
            "price": {{ variant.price | json }},
            "public_title": {{ variant.public_title | json }},
            "requires_selling_plan": {{ variant.requires_selling_plan | json }},
            "requires_shipping": {{ variant.requires_shipping | json }},
            "selling_plan_allocations": {{ variant.selling_plan_allocations | json }},
            "sku": {{ variant.sku | json }},
            "taxable": {{ variant.taxable | json }},
            "title": {{ variant.title | json }},
            "weight": {{ variant.weight | json }},
            "inventory_quantity": {{ variant.inventory_quantity | json }},
            "incoming": {{ variant.incoming | json }},
            "id": {{ variant.id | json }},
            "inventory_policy": {{ variant.inventory_policy | json }},
            "next_incoming_date": {{variant.next_incoming_date | json }}
          }
        {% endunless %}
        {% endunless%}
        {%- endfor -%}
      ],
      "vendor": "{{ product.vendor }}",
      "tags": {{ product.tags | json }},
      "review_count": {{ product.metafields.reviews.rating_count | json }},
      "review_rating": "{{ product.metafields.reviews.rating.value }}",
      "metafields": {{ product.metafields.product_subtitle | json }}
    }{%- unless forloop.last %},{% endunless -%}
  {%- endfor -%}
]
{% endpaginate %} 